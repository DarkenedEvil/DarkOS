os.pullEvent = os.pullEventRaw

local tArgs = {...}
if #tArgs < 1 then
	error("Expected Username but got less. Please report this to DarkenedEvil.")
end
if #tArgs > 1 then
	error("Expected Username but got more! Please report this to DarkenedEvil")
end

local username = tArgs[1]

function Header()
	term.setCursorPos(1,1)
	term.setBackgroundColor(colors.blue)
	term.clearLine()
	term.setCursorPos(2,1)
	print("[Home]     Welcome "..username)
end

function printcentred(text)
	local maxw, maxh = term.getSize() 
	local curx, cury = term.getCursorPos()
	term.setCursorPos((maxw-#text)/2,cury)
	term.write(text)
	term.setCursorPos(curx,cury+1)
	end

function drawDropDown()
	term.setBackgroundColor(colors.lightGray)
	term.setCursorPos(1,2)
	print("         ")
	print("Update   ")
	print("Settings ")
	print("About    ")
	print("Credits  ")
	print("Logout   ")
	print("Shutdown ")
	print("         ")
end

function drawUIcon()
	uIcon = paintutils.loadImage("/sys/Images/u.icon")
	paintutils.drawImage(uIcon,1,1)
	term.setCursorPos(35,15)
	term.setBackgroundColor(colors.lightGray)
	print(" User Control")
end

function drawShellIconBlinkOne()
	shellIcon = paintutils.loadImage("/sys/Images/shell.icon")
	paintutils.drawImage(shellIcon,1,1)
	term.setCursorPos(15,6)
	term.setBackgroundColor(colors.gray)
	print("> Shell")
end

function drawShellIconBlinkTwo()
	shellIcon = paintutils.loadImage("/sys/Images/shell.icon")
	paintutils.drawImage(shellIcon,1,1)
	term.setCursorPos(15,6)
	term.setBackgroundColor(colors.gray)
	print("  Shell")
end

function drawTaskBar()
	term.setBackgroundColor(colors.lightGray)
	term.setCursorPos(1,2)
	print("Task Bar")
	term.setCursorPos(1,4)
	print("App     ")
	print("Center  ")
	term.setCursorPos(1,7)
	print("File    ")
	print("Browser ")
	term.setCursorPos(1, 10)
	print("LuaIDE  ")
end

function drawAlert(text)
	term.setBackgroundColor(colors.red)
	local maxw, maxh = term.getSize()
	term.setCursorPos(1,math.floor(maxh/2))
	printcentred(text)
end

function drawAbout()
	aboutUI = paintutils.loadImage("/sys/Images/about.page")
	paintutils.drawImage(aboutUI,1,1)
	term.setBackgroundColor(colors.red)
	term.setCursorPos(40,5)
	print("X")
	term.setBackgroundColor(colors.gray)
	term.setCursorPos(13,6)
	print("DarkOS is an OS for ")
	term.setCursorPos(13,7)
	print("Computercraft that adds ")
	term.setCursorPos(13,8)
	print("multiusers and tab-")
	term.setCursorPos(13,9)
	print("progression login.")
	term.setCursorPos(13, 12)
	print("Version 0.0.1")
	
end

function drawCredits()
	creditUI = paintutils.loadImage("/sys/Images/credits.page")
	paintutils.drawImage(creditUI,1,1)
	term.setBackgroundColor(colors.red)
	term.setCursorPos(46,5)
	print("X")
	term.setBackgroundColor(colors.gray)
	term.setCursorPos(13,6)
	print("Credit where credit is due")
	term.setCursorPos(13,7)
end

function drawBackGround()
	term.clear()
	term.setCursorPos(1,1)
	term.setBackgroundColor(colors.lightBlue)
	backGround = paintutils.loadImage("/sys/Images/.background")
	paintutils.drawImage(backGround,1,1)
	Header()
	drawTaskBar()
	drawUIcon()	
	drawShellIconBlinkOne()
end
drawBackGround()
--local blink = 1
while true do
	local event, button, x, y = os.pullEvent()
	--[[os.startTimer(.5)
	local event, button, x, y = os.pullEvent()
	if blink == 1 then
		drawShellIconBlinkOne()
		blink = blink + 1
	elseif blink == 2 then
		drawShellIconBlinkTwo()
		blink = blink - 1
	else
		error("Unknown blink. Please report this to DarkenedEvil")
	end--]]
	if event == "mouse_click" then
		if x >= 3 and x <= 8 and y == 1 and button == 1 then --DropDown
			drawDropDown()
			while true do
				local event, button, x, y = os.pullEvent()
				--[[os.startTimer(.5)
				local event, button, x, y = os.pullEvent()
				if blink == 1 then
					drawShellIconBlinkOne()
					blink = blink + 1
				elseif blink == 2 then
					drawShellIconBlinkTwo()
					blink = blink - 1
				else
					error("Unknown blink. Please report this to DarkenedEvil")
				end--]]
				if event == "mouse_click" then
					if x >= 1 and x <= 8 and y == 3 and button == 1 then --Update
						--os.run({}, "update")
					elseif x >= 1 and x <= 8 and y == 4 and button == 1 then --Settings
						
					elseif x >= 1 and x <= 8 and y == 5 and button == 1 then --about
						drawBackGround()
						drawAbout()
						while true do
							local event, button, x, y = os.pullEvent()
							if event == "mouse_click" then
								if x == 40 and y == 5 and button == 1 then --close box
									drawBackGround()
									break
								end
							end
						end
						break
					elseif x >= 1 and x <= 8 and y == 6 and button == 1 then --credits
						drawBackGround()
						drawCredits()
						while true do
							local event, button, x, y = os.pullEvent()
							if event == "mouse_click" then
								if x == 46 and y == 5 and button == 1 then --close box
									drawBackGround()
									break
								end
							end
						end
						break
						elseif x >= 1 and x <= 8 and y == 7 and button == 1 then --Logout
							os.reboot()
						elseif x >= 1 and x <= 8 and y == 8 and button == 1 then --shutdown
							os.shutdown()
						elseif x >= 1 and x <= 7 and y == 1 and button == 1 then --Exit DropDown
							drawBackGround()
							break
					end
				end
			end
		end
		if x >= 37 and x <= 45 and y >= 5 and y <= 15 and button == 1 then --Usercontrol
			os.run({}, "/sys/usercontrol", tArgs[1])
		elseif x >= 1 and x <= 8 and y <=8 and y >= 7 and button == 1  then --FileBrowser
			os.run({}, "/programs/filebrowser")
		elseif x >= 13 and x <= 25 and y <= 15 and y >= 4 and button == 1 then --Shell
			os.run({},"/sys/shell", username)
		elseif x >= 1 and x <= 8 and y <= 10 and y >= 10 and button == 1 then --LuaIDE
			os.run({["shell"] = shell}, "/programs/luaide", "luaide", username)
		elseif x >=1 and x <= 8 and y <=5 and y >=4 and button == 1 then --AppCenter
			if Alert == true then
				drawBackGround()
				Alert = false
			else
				drawAlert("Comming Soon!")
				Alert = true
			end
		end
	end
end